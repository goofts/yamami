!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("vega-util"),require("vega-dataflow"),require("vega-expression"),require("vega-statistics"),require("d3-color"),require("d3-array"),require("d3-format"),require("d3-time-format"),require("vega-scale"),require("vega-scenegraph"),require("d3-geo"),require("vega-event-selector")):"function"==typeof define&&define.amd?define(["exports","vega-util","vega-dataflow","vega-expression","vega-statistics","d3-color","d3-array","d3-format","d3-time-format","vega-scale","vega-scenegraph","d3-geo","vega-event-selector"],t):t(e.vega=e.vega||{},e.vega,e.vega,e.vega,e.vega,e.d3,e.d3,e.d3,e.d3,e.vega,e.vega,e.d3,e.vega)}(this,function(e,G,c,o,t,n,i,a,r,d,f,l,p){"use strict";function s(e){return+e||0}var u=["value","update","react","bind"];function g(e,t){G.error(e+' for "outer" push: '+G.stringValue(t))}function h(t,e){var n,i=t.name;"outer"===t.push?(e.signals[i]||g("No prior signal definition",i),u.forEach(function(e){void 0!==t[e]&&g("Invalid property ",e)})):(n=e.addSignal(i,t.value),!1===t.react&&(n.react=!1),t.bind&&e.addBinding(i,t.bind))}var m={};function v(e,t,n){var i=e+":"+n,e=m[i];return e&&e[0]===t||(m[i]=e=[t,t(n)]),e[1]}function y(e,t){return v("timeFormat",r.timeFormat,t)(e)}var b=new Date(2e3,0,1);function x(e,t,n){return b.setMonth(e),b.setDate(t),y(b,n)}function k(t,e,n){try{t[e].apply(t,["EXPRESSION"].concat([].slice.call(n)))}catch(e){t.warn(e)}return n[n.length-1]}var S="undefined"!=typeof window&&window||null;var R="Literal",w="%",O=":";function z(e,t){return G.isFunction(e)?e:G.isString(e)?(e=t.scales[e])&&e.value:void 0}function P(e,t,n){var i=w+n;if(!t.hasOwnProperty(i))try{t[i]=e.scaleRef(n)}catch(e){}}function j(e,t,n,i){if(t[0].type===R)P(n,i,t[0].value);else if("Identifier"===t[0].type)for(e in n.scales)P(n,i,e)}function D(i,a){return function(e,t,n){if(e){n=z(e,(n||this).context);return n&&n.path[i](t)}return a(t)}}var $=D("area",l.geoArea),E=D("bounds",l.geoBounds),l=D("centroid",l.geoCentroid);function _(e){e=this.context.data[e];return e?e.values.value:[]}function V(e,t,n,i){t[0].type!==R&&G.error("First argument to data functions must be a string literal.");var a=t[0].value,t=O+a;i.hasOwnProperty(t)||(i[t]=n.getData(a).tuplesRef())}var F={};function A(e){return e.data}function W(e,t){e=_.call(t,e);return e.root&&e.root.lookup||F}var L=function(e,t,n,i){var a=t[0],r=t[t.length-1];return r<a&&(t=a,a=r,r=t),i=void 0===i||i,((n=void 0===n||n)?a<=e:a<e)&&(i?e<=r:e<r)};function C(e,t){return e===t||e!=e&&t!=t||G.isArray(e)&&G.isArray(t)&&e.length===t.length&&function(e,t){for(var n=0,i=e.length;n<i;++n)if(!C(e[n],t[n]))return;return 1}(e,t)}function M(n){return function(e){for(var t in n)if(!C(e[t],n[t]))return!1;return!0}}var q="bin_",B="intersect",N="union",U="index:unit";function T(e,t){for(var n,i=t.fields,a=t.values,r=t.getter||(t.getter=[]),o=i.length,l=0;l<o;++l)if(r[l]=r[l]||G.field(i[l]),n=r[l](e),G.isDate(n)&&(n=G.toNumber(n)),G.isDate(a[l])&&(a[l]=G.toNumber(a[l])),t[q+i[l]]){if(G.isDate(a[l][0])&&(a[l]=a[l].map(G.toNumber)),!L(n,a[l],!0,!1))return!1}else if(n!==a[l])return!1;return!0}function I(e,t){for(var n,i,a=t.intervals,r=a.length,o=0;o<r;++o){if(n=a[o].extent,i=(a[o].getter||(a[o].getter=G.field(a[o].field)))(e),!n||n[0]===n[1])return!1;if(G.isDate(i)&&(i=G.toNumber(i)),G.isDate(n[0])&&(n=a[o].extent=n.map(G.toNumber)),G.isNumber(n[0])&&!L(i,n))return!1;if(G.isString(n[0])&&n.indexOf(i)<0)return!1}return!0}function X(e,t,n,i){for(var a,r,o,l,s,e=this.context.data[e],u=e?e.values.value:[],d=e?e[U]&&e[U].value:void 0,f=n===B,c=u.length,p=0;p<c;++p)if(a=u[p],d&&f){if(-1!==(o=(r=r||{})[l=a.unit]||0)){if(s=i(t,a),r[l]=s?-1:++o,s&&1===d.size)return!0;if(!s&&o===d.get(l).count)return!1}}else if(f^(s=i(t,a)))return s;return c&&f}function H(e,t,n){return X.call(this,e,t,n,T)}function Y(e,t,n,i){t[0].type!==R&&G.error("First argument to indata must be a string literal.");var a=t[0].value;(2<=t.length&&t[t.length-1].value)!==B||i.hasOwnProperty("@unit")||(i["@unit"]=n.getData(a).indataRef(n,"unit")),V(0,t,n,i)}function J(e,t,n,i){var a,r,o,l,s=this.context.data[e],e=s?s.values.value:[],s=s?s[U]&&s[U].value:void 0,u=e[0],d=0;if(u){for(a=(t?u.encodings:u.fields).length;d<a;++d)if(t&&u.encodings[d]===t||n&&u.fields[d]===n){r=d,o=u[q+u.fields[d]];break}return s&&1===s.size&&(i=N),e=s&&i===B?(l=e.reduce(function(e,t){return(e[t.unit]||(e[t.unit]=[])).push({unit:t.unit,value:t.values[r]}),e},{}),Object.keys(l).map(function(e){return{unit:e,value:(o?Q:K)(l[e],N)}})):e.map(function(e){return{unit:e.unit,value:e.values[r]}}),(o?Q:K)(e,i)}}function K(e,t){for(var n,i,a,r,o={},l=0,s={},u=[],d=0,f=e.length;d<f;++d)i=(n=e[d]).unit,r=n.value,o[i]||(o[i]=++l),(a=s[r])||(s[r]=a={value:r,units:{},count:0}),a.units[i]||(a.units[i]=++a.count);for(r in s)a=s[r],t===B&&a.count!==l||u.push(a.value);return u.length?u:void 0}function Q(e,t){for(var n,i,a,r,o=t===B?ee:Z,l=0,s=e.length;l<s;++l)n=e[l].value,G.isDate(n[0])&&(n=n.map(G.toNumber)),a=n[0],(r=n[1])<a&&(r=n[0],a=n[1]),i=i?o(i,a,r):[a,r];return i&&i.length&&+i[0]!=+i[1]?i:void 0}function Z(e,t,n){return e[0]>t&&(e[0]=t),e[1]<n&&(e[1]=n),e}function ee(e,t,n){return n<e[0]||e[1]<t?[]:(e[0]<t&&(e[0]=t),e[1]>n&&(e[1]=n),e)}var te={random:function(){return t.random()},isArray:G.isArray,isBoolean:G.isBoolean,isDate:G.isDate,isNumber:G.isNumber,isObject:G.isObject,isRegExp:G.isRegExp,isString:G.isString,isTuple:c.isTuple,toBoolean:G.toBoolean,toDate:G.toDate,toNumber:G.toNumber,toString:G.toString,pad:G.pad,peek:G.peek,truncate:G.truncate,rgb:n.rgb,lab:n.lab,hcl:n.hcl,hsl:n.hsl,sequence:i.range,format:function(e,t){return v("format",a.format,t)(e)},utcFormat:function(e,t){return v("utcFormat",r.utcFormat,t)(e)},utcParse:function(e,t){return v("utcParse",r.utcParse,t)(e)},timeFormat:y,timeParse:function(e,t){return v("timeParse",r.timeParse,t)(e)},monthFormat:function(e){return x(e,1,"%B")},monthAbbrevFormat:function(e){return x(e,1,"%b")},dayFormat:function(e){return x(0,2+e,"%A")},dayAbbrevFormat:function(e){return x(0,2+e,"%a")},quarter:function(e){return 1+~~(new Date(e).getMonth()/3)},utcquarter:function(e){return 1+~~(new Date(e).getUTCMonth()/3)},warn:function(){return k(this.context.dataflow,"warn",arguments)},info:function(){return k(this.context.dataflow,"info",arguments)},debug:function(){return k(this.context.dataflow,"debug",arguments)},inScope:function(e){var t=this.context.group,n=!1;if(t)for(;e;){if(e===t){n=!0;break}e=e.mark.group}return n},clampRange:function(e,t,n){var i,a=e[0],e=e[1];return e<a&&(i=e,e=a,a=i),n-t<=(i=e-a)?[t,n]:[Math.min(Math.max(a,t),n-i),Math.min(Math.max(e,i),n)]},pinchDistance:function(e){var e=(t=e.touches)[0].clientX-t[1].clientX,t=t[0].clientY-t[1].clientY;return Math.sqrt(e*e+t*t)},pinchAngle:function(e){return e=e.touches,Math.atan2(e[0].clientY-e[1].clientY,e[0].clientX-e[1].clientX)},screen:function(){return S?S.screen:{}},containerSize:function(){var e=this.context.dataflow;return(e=e.container&&e.container())?[e.clientWidth,e.clientHeight]:[void 0,void 0]},windowSize:function(){return S?[S.innerWidth,S.innerHeight]:[void 0,void 0]},span:function(e){return e[e.length-1]-e[0]||0},flush:function(e,t,n,i,a,r){var o=Math.abs(t-e[0]),t=Math.abs(G.peek(e)-t);return o<t&&o<=n?i:t<=n?a:r},bandspace:function(e,t,n){return d.bandSpace(e||0,t||0,n||0)},inrange:L,setdata:function(e,t){var n=this.context.dataflow,e=this.context.data[e].input;return n.pulse(e,n.changeset().remove(G.truthy).insert(t)),1},pathShape:function(t){var n=null;return function(e){return e?f.pathRender(e,n=n||f.pathParse(t)):t}},panLinear:G.panLinear,panLog:G.panLog,panPow:G.panPow,zoomLinear:G.zoomLinear,zoomLog:G.zoomLog,zoomPow:G.zoomPow,encode:function(e,t,n){var i,a;return e&&(i=this.context.dataflow,a=e.mark.source,i.pulse(a,i.changeset().encode(e,t))),void 0!==n?n:e},modify:function(e,t,n,i,a,r){var o,l,s=this.context.dataflow,u=this.context.data[e],d=u.input,f=u.changes,e=s.stamp();if(!1===s._trigger||!(d.value.length||t||i))return 0;if((!f||f.stamp<e)&&(u.changes=f=s.changeset(),f.stamp=e,s.runAfter(function(){u.modified=!0,s.pulse(d,f).run()},!0,1)),n&&(o=!0===n?G.truthy:G.isArray(n)||c.isTuple(n)?n:M(n),f.remove(o)),t&&f.insert(t),i&&(o=M(i),d.value.some(o)?f.remove(o):f.insert(i)),a)for(l in r)f.modify(a,l,r[l]);return 1}},ne=["view","item","group","xy","x","y"],ie={};function ae(e,t,n){return 1===arguments.length?te[e]:(te[e]=t,n&&(ie[e]=n),oe&&(oe.functions[e]="this."+e),this)}ae("bandwidth",function(e,t){return(t=z(e,(t||this).context))&&t.bandwidth?t.bandwidth():0},j),ae("copy",function(e,t){return(t=z(e,(t||this).context))?t.copy():void 0},j),ae("domain",function(e,t){return(t=z(e,(t||this).context))?t.domain():[]},j),ae("range",function(e,t){return(t=z(e,(t||this).context))&&t.range?t.range():[]},j),ae("invert",function(e,t,n){return(n=z(e,(n||this).context))?(G.isArray(t)?n.invertRange||n.invert:n.invert||n.invertExtent)(t):void 0},j),ae("scale",function(e,t,n){return(n=z(e,(n||this).context))?n(t):void 0},j),ae("gradient",function(e,t,n,i,a){e=z(e,(a||this).context);var r=f.Gradient(t,n),o=e.domain(),t=o[0],n=o[o.length-1],l=d.scaleFraction(e,t,n);e.ticks&&(t!==(o=e.ticks(+i||15))[0]&&o.unshift(t),n!==o[o.length-1]&&o.push(n));for(var s=0,u=o.length;s<u;++s)r.stop(l(o[s]),e(o[s]));return r},j),ae("geoArea",$,j),ae("geoBounds",E,j),ae("geoCentroid",l,j),ae("geoShape",function(e,t,n){var i=z(e,(n||this).context);return function(e){return i?i.path.context(e)(t):""}},j),ae("indata",function(e,t,n){return t=this.context.data[e]["index:"+t],(n=t?t.value.get(n):void 0)&&n.count},function(e,t,n,i){t[0].type!==R&&G.error("First argument to indata must be a string literal."),t[1].type!==R&&G.error("Second argument to indata must be a string literal.");var a=t[0].value,r=t[1].value,t="@"+r;i.hasOwnProperty(t)||(i[t]=n.getData(a).indataRef(n,r))}),ae("data",_,V),ae("vlSingle",H,V),ae("vlSingleDomain",J,V),ae("vlMulti",H,Y),ae("vlMultiDomain",J,Y),ae("vlInterval",function(e,t,n){return X.call(this,e,t,n,I)},V),ae("vlIntervalDomain",function(e,t,n,i){var a,r,o,l,s=(e=(e=this.context.data[e])?e.values.value:[])[0],u=0;if(s){for(a=s.intervals.length;u<a;++u)if(r=s.intervals[u],t&&r.encoding===t||n&&r.field===n){if(!r.extent)return;o=u,l=2<r.extent.length;break}return e=e.reduce(function(e,t){var n=t.intervals[o].extent,n=l?n.map(function(e){return{unit:t.unit,value:e}}):{unit:t.unit,value:n};return l?e.push.apply(e,n):e.push(n),e},[]),(l?K:Q)(e,i)}},V),ae("treePath",function(e,t,n){return e=W(e,this),t=e[t],n=e[n],t&&n?t.path(n).map(A):void 0},V),ae("treeAncestors",function(e,t){return(t=W(e,this)[t])?t.ancestors().map(A):void 0},V);var re={blacklist:["_"],whitelist:["datum","event","item"],fieldvar:"datum",globalvar:function(e){return"_["+G.stringValue("$"+e)+"]"},functions:function(e){var t,n=o.functions(e);for(t in ne.forEach(function(e){n[e]="event.vega."+e}),te)n[t]="this."+t;return n},constants:o.constants,visitors:ie},oe=o.codegen(re),le=function(t,i,e){var n,a,r={};try{n=o.parse(t)}catch(e){G.error("Expression parse error: "+G.stringValue(t))}return n.visit(function(e){var t,n;"CallExpression"===e.type&&(t=e.callee.name,(n=re.visitors[t])&&n(t,e.arguments,i,r))}),(a=oe(n)).globals.forEach(function(e){var t="$"+e;!r.hasOwnProperty(t)&&i.getSignal(e)&&(r[t]=i.signalRef(e))}),{$expr:e?e+"return("+a.code+");":a.code,$fields:a.fields,$params:r}};function se(e,t,n,i){this.id=-1,this.type=e,this.value=t,this.params=n,i&&(this.parent=i)}function ue(e,t,n,i){return new se(e,t,n,i)}function de(e,t){return ue("operator",e,t)}function fe(e){var t={$ref:e.id};return e.id<0&&(e.refs=e.refs||[]).push(t),t}var ce={$tupleid:1,toString:function(){return":_tupleid_:"}};function pe(e,t){return t?{$field:e,$name:t}:{$field:e}}var ge=pe("key");function he(e,t){return{$compare:e,$order:t}}var me="descending";function ve(e,t){return(e&&e.signal?"$"+e.signal:e||"")+(e&&t?"_":"")+(t&&t.signal?"$"+t.signal:t||"")}var ye="scope",be="view";function xe(e){return e&&e.signal}function ke(e,t){return null!=e?e:t}function Se(e,t){return e.signal?t.getSignal(e.signal).id:e.scale?t.getScale(e.scale).id:Re(e,t)}function Re(e,t){return(e.merge?we:e.stream?Oe:e.type?ze:G.error("Invalid stream specification: "+G.stringValue(e)))(e,t)}function we(e,t){e=Pe({merge:e.merge.map(function(e){return Re(e,t)})},e,t);return t.addStream(e).id}function Oe(e,t){e=Pe({stream:Re(e.stream,t)},e,t);return t.addStream(e).id}function ze(e,t){var n,n=t.event((n=e.source)!==ye&&n||be,e.type),e=Pe({stream:n},e,t);return 1===Object.keys(e).length?n:t.addStream(e).id}function Pe(e,t,n){var i,a,r,o=t.between;return o&&(2!==o.length&&G.error('Stream "between" parameter must have 2 entries: '+G.stringValue(t)),e.between=[Re(o[0],n),Re(o[1],n)]),o=t.filter?G.array(t.filter):[],(t.marktype||t.markname||t.markrole)&&o.push((i=t.marktype,a=t.markname,r=t.markrole,(n="event.item")+(i&&"*"!==i?"&&"+n+".mark.marktype==='"+i+"'":"")+(r?"&&"+n+".mark.role==='"+r+"'":"")+(a?"&&"+n+".mark.name==='"+a+"'":""))),t.source===ye&&o.push("inScope(event.item)"),o.length&&(e.filter=le("("+o.join(")&&(")+")").$expr),null!=(o=t.throttle)&&(e.throttle=+o),null!=(o=t.debounce)&&(e.debounce=+o),t.consume&&(e.consume=!0),e}function je(e,s){var t,u=s.getSignal(e.name);e.update&&(t=le(e.update,s),u.update=t.$expr,u.params=t.$params),e.on&&e.on.forEach(function(e){var t,n,i,a,r,o,l;t=e,n=s,i=u.id,r=t.events,o=t.update,e=t.encode,l=[],r||G.error("Signal update missing events specification."),G.isString(r)&&(r=p.selector(r,n.isSubscope()?ye:be)),(r=G.array(r).filter(function(e){return e.signal||e.scale?(l.push(e),0):1})).length&&l.push(1<r.length?{merge:r}:r[0]),null!=e&&(o&&G.error("Signal encode and update are mutually exclusive."),o="encode(item(),"+G.stringValue(e)+")"),o=G.isString(o)?le(o,n,De):null!=o.expr?le(o.expr,n,De):null!=o.value?o.value:null!=o.signal?{$expr:"_.value",$params:{value:n.signalRef(o.signal)}}:G.error("Invalid signal update specification."),a={target:i,update:o},t.force&&(a.options={force:!0}),l.forEach(function(e){e={source:Se(e,n)},n.addUpdate(G.extend(e,a))})})}var De="var datum=event.item&&event.item.datum;";function $e(i){return function(e,t,n){return ue(i,t,e||void 0,n)}}var Ee=$e("aggregate"),_e=$e("axisticks"),Ve=$e("bound"),Fe=$e("collect"),Ae=$e("compare"),We=$e("datajoin"),Le=$e("encode"),Ce=$e("facet"),Me=$e("field"),qe=$e("key"),Be=$e("legendentries"),Ne=$e("mark"),Ue=$e("multiextent"),Te=$e("multivalues"),Ie=$e("overlap"),Xe=$e("params"),He=$e("prefacet"),Ye=$e("projection"),Ge=$e("proxy"),Je=$e("relay"),Ke=$e("render"),Qe=$e("scale"),Ze=$e("sieve"),et=$e("sortitems"),tt=$e("viewlayout"),nt=$e("values"),it=0,l=["identity","ordinal","band","point","bin-linear","bin-ordinal","linear","pow","sqrt","log","sequential","time","utc","quantize","quantile","threshold"],at=G.toSet(l),rt=G.toSet(l.slice(1,6));function ot(e){return rt.hasOwnProperty(e)}function lt(e){return"quantile"===e}function st(e,t){var n,i,a,r=t.getScale(e.name).params;for(n in r.domain=ct(e.domain,e,t),null!=e.range&&(r.range=function e(t,n,i){var a=t.range,r=n.config.range;{if(a.signal)return n.signalRef(a.signal);if(G.isString(a)){if(r&&r.hasOwnProperty(a))return t=G.extend({},t,{range:r[a]}),e(t,n,i);"width"===a?a=[0,{signal:"width"}]:"height"===a?a=ot(t.type)?[0,{signal:"height"}]:[{signal:"height"},0]:G.error("Unrecognized scale range value: "+G.stringValue(a))}else{if(a.scheme)return i.scheme=ut(a.scheme,n),a.extent&&(i.schemeExtent=dt(a.extent,n)),void(a.count&&(i.schemeCount=ut(a.count,n)));if(a.step)return void(i.rangeStep=ut(a.step,n));if(ot(t.type)&&!G.isArray(a))return ct(a,t,n);G.isArray(a)||G.error("Unsupported range type: "+G.stringValue(a))}}return a.map(function(e){return ut(e,n)})}(e,t,r)),null!=e.interpolate&&(a=e.interpolate,(i=r).interpolate=ut(a.type||a),null!=a.gamma&&(i.interpolateGamma=ut(a.gamma))),null!=e.nice&&(a=e.nice,r.nice=G.isObject(a)?{interval:ut(a.interval),step:ut(a.step)}:ut(a)),e)r.hasOwnProperty(n)||"name"===n||(r[n]=ut(e[n],t))}function ut(e,t){return G.isObject(e)?e.signal?t.signalRef(e.signal):G.error("Unsupported object: "+G.stringValue(e)):e}function dt(e,t){return e.signal?t.signalRef(e.signal):e.map(function(e){return ut(e,t)})}function ft(e){G.error("Can not find data set: "+G.stringValue(e))}function ct(e,t,n){if(e)return e.signal?n.signalRef(e.signal):(G.isArray(e)?function(e,t,n){return e.map(function(e){return ut(e,n)})}:e.fields?function(e,t,n){var i=e.data,a=e.fields.reduce(function(e,t){return t=G.isString(t)?{data:i,field:t}:G.isArray(t)||t.signal?function(e,t){var n="_:vega:_"+it++,i=Fe({});G.isArray(e)?i.value={$ingest:e}:e.signal&&(e="setdata("+G.stringValue(n)+","+e.signal+")",i.params.input=t.signalRef(e));return t.addDataPipeline(n,[i,Ze({})]),{data:n,field:"data"}}(t,n):t,e.push(t),e},[]);return(ot(t.type)?function(e,n,t){return t=t.map(function(e){var t=n.getData(e.data);return t||ft(e.data),t.countsRef(n,e.field)}),t=n.add(Ee({groupby:ge,ops:["sum"],fields:[n.fieldRef("count")],as:["count"],pulse:t})),t=n.add(Fe({pulse:fe(t)})),t=n.add(nt({field:ge,sort:n.sortRef(pt(e.sort,!0)),pulse:fe(t)})),fe(t)}:lt(t.type)?function(e,n,t){t=t.map(function(e){var t=n.getData(e.data);return t||ft(e.data),t.domainRef(n,e.field)});return fe(n.add(Te({values:t})))}:function(e,n,t){t=t.map(function(e){var t=n.getData(e.data);return t||ft(e.data),t.extentRef(n,e.field)});return fe(n.add(Ue({extents:t})))})(e,n,a)}:function(e,t,n){var i=n.getData(e.data);i||ft(e.data);return ot(t.type)?i.valuesRef(n,e.field,pt(e.sort,!1)):lt(t.type)?i.domainRef(n,e.field):i.extentRef(n,e.field)})(e,t,n);null==t.domainMin&&null==t.domainMax||G.error("No scale domain defined for domainMin/domainMax to override.")}function pt(e,t){return e&&(e.field||e.op?e.field||"count"===e.op?t&&e.field?G.error("Multiple domain scales can not sort by field."):t&&e.op&&"count"!==e.op&&G.error("Multiple domain scales support op count only."):G.error("No field provided for sort aggregate op: "+e.op):G.isObject(e)?e.field="key":e={field:"key"}),e}function gt(e,t){var n,i={};for(n in e)"name"!==n&&(i[n]=function t(e,n,i){return G.isArray(e)?e.map(function(e){return t(e,n,i)}):G.isObject(e)?e.signal?i.signalRef(e.signal):"fit"===n?e:G.error("Unsupported parameter object: "+G.stringValue(e)):e}(e[n],n,t));t.addProjection(e.name,i)}function ht(e,t,n,i){return function e(t,n,i,a){var r,o,l;if(t.signal)r="datum",l=Dt(t.signal,n,i,a);else if(t.group||t.parent){for(o=Math.max(1,t.level||1),r="item";0<o--;)r+=".mark.group";t.parent?(l=t.parent,r+=".datum"):l=t.group}else t.datum?(r="datum",l=t.datum):G.error("Invalid field reference: "+G.stringValue(t));t.signal||(l=G.isString(l)?(a[l]=1,G.splitAccessPath(l).map(G.stringValue).join("][")):e(l,n,i,a));return r+"["+l+"]"}(G.isObject(e)?e:{datum:e},t,n,i)}var mt="top",vt="left",yt="bottom",bt="label",xt="perc",kt="value",St="guide-label",Rt="guide-title",wt=["shape","size","fill","stroke","strokeDash","opacity"],Ot={name:1,interactive:1},zt=G.toSet(["rule"]),Pt=G.toSet(["group","image","rect"]),jt=function(e,t){var n="";return zt[t]||(e.x2&&(e.x?(Pt[t]&&(n+="if(o.x>o.x2)$=o.x,o.x=o.x2,o.x2=$;"),n+="o.width=o.x2-o.x;"):n+="o.x=o.x2-(o.width||0);"),e.xc&&(n+="o.x=o.xc-(o.width||0)/2;"),e.y2&&(e.y?(Pt[t]&&(n+="if(o.y>o.y2)$=o.y,o.y=o.y2,o.y2=$;"),n+="o.height=o.y2-o.y;"):n+="o.y=o.y2-(o.height||0);"),e.yc&&(n+="o.y=o.yc-(o.height||0)/2;")),n},Dt=function(e,t,n,i){t=le(e,t);return t.$fields.forEach(function(e){i[e]=1}),G.extend(n,t.$params),t.$expr};function $t(e,t,n,i,a){var r,o,l,a=Et(e.scale,n,i,a);return null!=e.range?(o=a+".range()",t=0===(r=+e.range)?o+"[0]":"($="+o+","+(1===r?"$[$.length-1]":"$[0]+"+r+"*($[$.length-1]-$[0])")+")"):(void 0!==t&&(t=a+"("+t+")"),e.band&&(l=function(e,t){if(!G.isString(e))return-1;e=t.scaleType(e);return"band"===e||"point"===e?1:0}(e.scale,n))&&(r=(o=a+".bandwidth")+"()"+(1===(r=+e.band)?"":"*"+r),l<0&&(r="("+o+"?"+r+":0)"),t=(t?t+"+":"")+r,e.extra&&(t="(datum.extra?"+a+"(datum.extra.value):"+t+")")),null==t&&(t="0")),t}function Et(e,t,n,i){if(G.isString(e))a=w+e,n.hasOwnProperty(a)||(n[a]=t.scaleRef(e)),a=G.stringValue(a);else{for(var a in t.scales)n[w+a]=t.scaleRef(a);a=G.stringValue(w)+"+"+(e.signal?"("+Dt(e.signal,t,n,i)+")":ht(e,t,n,i))}return"_["+a+"]"}function _t(e,t,n,i){return G.isObject(e)?"("+Vt(null,e,t,n,i)+")":e}var Vt=function(e,t,n,i,a){if(null!=t.gradient)return o=n,l=i,s=a,"this.gradient("+Et((r=t).gradient,o,l,s)+","+G.stringValue(r.start)+","+G.stringValue(r.stop)+","+G.stringValue(r.count)+")";var r,o,l,s,u,d,f,c,u=t.signal?Dt(t.signal,n,i,a):t.color?(u=t.color,d=n,f=i,c=a,u.c?p("hcl",u.h,u.c,u.l):u.h||u.s?p("hsl",u.h,u.s,u.l):u.l||u.a?p("lab",u.l,u.a,u.b):u.r||u.g||u.b?p("rgb",u.r,u.g,u.b):null):null!=t.field?ht(t.field,n,i,a):void 0!==t.value?G.stringValue(t.value):void 0;function p(e,t,n,i){return"this."+e+"("+[Vt(null,t,d,f,c),Vt(null,n,d,f,c),Vt(null,i,d,f,c)].join(",")+").toString()"}return null!=t.scale&&(u=$t(t,u,n,i,a)),void 0===u&&(u=null),null!=t.exponent&&(u="Math.pow("+u+","+_t(t.exponent,n,i,a)+")"),null!=t.mult&&(u+="*"+_t(t.mult,n,i,a)),null!=t.offset&&(u+="+"+_t(t.offset,n,i,a)),t.round&&(u="Math.round("+u+")"),u},Ft=function(e,t,n){return e+"["+G.stringValue(t)+"]="+n+";"},At=function(n,e,i,a,r){var o="";return e.forEach(function(e){var t=Vt(n,e,i,a,r);o+=e.test?Dt(e.test,i,a,r)+"?"+t+":":t}),Ft("o",n,o)};var Wt="mark",Lt="frame",Ct="scope",Mt="axis-domain",qt="axis-grid",Bt="axis-label",Nt="axis-tick",Ut="axis-title",Tt="legend-entry",It="legend-label",Xt="legend-symbol",Ht="legend-title";function Yt(e){return G.isObject(e)?e:{value:e}}function Gt(e,t,n){return null!=n?(e[t]=G.isObject(n)&&!G.isArray(n)?n:{value:n},1):0}function Jt(e,t,n){for(var i in t)n&&n.hasOwnProperty(i)||(e[i]=G.extend(e[i]||{},t[i]));return e}function Kt(e,t,n,i,a,r){var o,l;for(l in(r=r||{}).encoders={$encode:o={}},e=function(i,e,t,n,a){var r,o,l={};"legend"!=t&&0!==String(t).indexOf("axis")||(t=null);for(r in o=t===Lt?a.group:t===Wt?G.extend({},a.mark,a[e]):null)Qt(r,i)||("fill"===r||"stroke"===r)&&(Qt("fill",i)||Qt("stroke",i))||(l[r]={value:o[r]});return G.array(n).forEach(function(e){var t,n=a.style&&a.style[e];for(t in n)Qt(t,i)||(l[t]={value:n[t]})}),(i=G.extend({},i)).enter=G.extend(l,i.enter),i}(e,t,n,i,a.config))o[l]=function(e,t,n,i){var a,r,o={},l="var o=item,datum=o.datum,$;";for(a in e)r=e[a],G.isArray(r)?l+=At(a,r,i,n,o):(r=Vt(a,r,i,n,o),l+=Ft("o",a,r));return l+=jt(e,t),{$expr:l+="return 1;",$fields:Object.keys(o),$output:Object.keys(e)}}(e[l],t,r,a);return r}function Qt(e,t){return t&&(t.enter&&t.enter[e]||t.update&&t.update[e])}function Zt(e,t,n,i,a,r,o){return{type:e,name:o?o.name:void 0,role:t,style:o&&o.style||n,key:i,from:a,interactive:!(!o||!o.interactive),encode:Jt(r,o,Ot)}}function en(e,t,n,i,a,r,o){return{type:tn,name:n,role:e,style:t,from:i,interactive:a||!1,encode:r,marks:o}}var tn="group",nn="rule",an="text";function rn(e){return G.isObject(e)&&e.signal?e.signal:G.stringValue(e)}function on(e){var t=e.role||"";return t.indexOf("axis")&&t.indexOf("legend")?e.type===tn?Ct:t||Wt:t}function ln(e,t){var n=c.definition(e.type);n||G.error("Unrecognized transform type: "+G.stringValue(e.type));var i=ue(n.type.toLowerCase(),null,sn(n,e,t));return e.signal&&t.addSignal(e.signal,t.proxy(i)),i.metadata=n.metadata||{},i}function sn(e,t,n){for(var i,a={},r=0,o=e.params.length;r<o;++r)a[(i=e.params[r]).name]=function(t,e,n){var i=t.type,a=e[t.name];{if("index"===i)return function(e,t){G.isString(e.from)||G.error('Lookup "from" parameter must be a string literal.');return t.getData(e.from).lookupRef(t,e.key)}(e,n);if(void 0===a)return void(t.required&&G.error("Missing required "+G.stringValue(e.type)+" parameter: "+G.stringValue(t.name)));if("param"===i)return function(t,e,n){e=e[t.name];return t.array?(G.isArray(e)||G.error("Expected an array of sub-parameters. Instead: "+G.stringValue(e)),e.map(function(e){return dn(t,e,n)})):dn(t,e,n)}(t,e,n);if("projection"===i)return n.projectionRef(e[t.name])}return t.array&&!xe(a)?a.map(function(e){return un(t,e,n)}):un(t,a,n)}(i,t,n);return a}function un(e,t,n){var i=e.type;if(xe(t))return fn(i)?G.error("Expression references can not be signals."):cn(i)?n.fieldRef(t):pn(i)?n.compareRef(t):n.signalRef(t.signal);var a=e.expr||cn(i);return a&&((e=t)&&e.expr)?le(t.expr,n):a&&((a=t)&&a.field)?pe(t.field):fn(i)?le(t,n):"data"===i?fe(n.getData(t).values):cn(i)?pe(t):pn(i)?n.compareRef(t):t}function dn(e,t,n){for(var i,a,r,o=0,l=e.params.length;o<l;++o){for(r in(a=e.params[o]).key)if(a.key[r]!==t[r]){a=null;break}if(a)break}return a||G.error("Unsupported parameter: "+G.stringValue(t)),i=G.extend(sn(a,t,n),a.key),fe(n.add(Xe(i)))}function fn(e){return"expr"===e}function cn(e){return"field"===e}function pn(e){return"compare"===e}function gn(e,t,n,i,a){this.scope=e,this.input=t,this.output=n,this.values=i,this.aggregate=a,this.index={}}gn.fromEntries=function(e,t){var n=t.length,i=1,a=t[0],r=t[n-1],o=t[n-2],l=null;for(e.add(t[0]);i<n;++i)t[i].params.pulse=fe(t[i-1]),e.add(t[i]),"aggregate"===t[i].type&&(l=t[i]);return new gn(e,a,o,r,l)};l=gn.prototype;function hn(e){return G.isString(e)?e:null}function mn(e,t,n){var i,a=ve(n.op,n.field);if(t.ops){for(var r=0,o=t.as.length;r<o;++r)if(t.as[r]===a)return}else t.ops=["count"],t.fields=[null],t.as=["count"];n.op&&(t.ops.push((i=n.op.signal)?e.signalRef(i):n.op),t.fields.push(e.fieldRef(n.field)),t.as.push(a))}function vn(e,t,n,i,a,r,o){var l,s,u=t[n]||(t[n]={}),d=(s=r,G.isObject(s)?(s.order===me?"-":"+")+ve(s.op,s.field):""),n=hn(a);return null!=n&&(e=t.scope,l=u[n+=d?"|"+d:""]),l||(s=r?{field:ge,pulse:t.countsRef(e,a,r)}:{field:e.fieldRef(a),pulse:fe(t.output)},d&&(s.sort=e.sortRef(r)),s=e.add(ue(i,void 0,s)),o&&(t.index[a]=s),l=fe(s),null!=n&&(u[n]=l)),l}l.countsRef=function(e,t,n){var i,a=this.counts||(this.counts={}),r=hn(t);return null!=r&&(e=this.scope,i=a[r]),i?n&&n.field&&mn(e,i.agg.params,n):(t={groupby:e.fieldRef(t,"key"),pulse:fe(this.output)},n&&n.field&&mn(e,t,n),t=e.add(Ee(t)),i=e.add(Fe({pulse:fe(t)})),i={agg:t,ref:fe(i)},null!=r&&(a[r]=i)),i.ref},l.tuplesRef=function(){return fe(this.values)},l.extentRef=function(e,t){return vn(e,this,"extent","extent",t,!1)},l.domainRef=function(e,t){return vn(e,this,"domain","values",t,!1)},l.valuesRef=function(e,t,n){return vn(e,this,"vals","values",t,n||!0)},l.lookupRef=function(e,t){return vn(e,this,"lookup","tupleindex",t,!1)},l.indataRef=function(e,t){return vn(e,this,"indata","tupleindex",t,!0,!0)};function yn(e,t,n){var i=e.remove,a=e.insert,r=e.toggle,o=e.modify,l=e.values,s=t.add(de()),l="if("+e.trigger+',modify("'+n+'",'+[a,i,r,o,l].map(function(e){return null==e?"null":e}).join(",")+"),0)",t=le(l,t);s.update=t.$expr,s.params=t.$params}function bn(e,t){var n,i,a,r,o,l,s,u,d,f,c,p,g,h,m,v=on(e),y=e.type===tn,b=e.from&&e.from.facet,x=e.layout||v===Ct||v===Lt,k=v===Wt||x||b,S=e.overlap;r=e.from,o=y,h=t,r?(l=r.facet)&&(o||G.error("Only group marks can be faceted."),null!=l.field?c=u=fe(h.getData(l.data).output):(r.data?u=fe(h.getData(r.data).aggregate):((d=ln(G.extend({type:"aggregate",groupby:G.array(l.groupby)},l.aggregate),h)).params.key=h.keyRef(l.groupby),d.params.pulse=fe(h.getData(l.data).output),c=u=fe(h.add(d))),d=h.keyRef(l.groupby,!0))):c=fe(h.add(Fe(null,[{}]))),d={key:d,pulse:c=c||(r.$ref?r:fe(h.getData(r.data).output)),parent:u},h=fe(i=t.add(We({key:d.key||(e.key?pe(e.key):void 0),pulse:d.pulse,clean:!y}))),i=r=t.add(Fe({pulse:h})),i=t.add(Ne({markdef:{marktype:(c=e).type,name:c.name||void 0,role:c.role||on(c),zindex:+c.zindex||void 0},interactive:(u=e.interactive,c=t,u&&u.signal?c.signalRef(u.signal):!1!==u),clip:(c=e.clip,u=t,G.isObject(c)&&(c.signal?s=c.signal:c.path?s="pathShape("+rn(c.path)+")":c.sphere&&(s="geoShape("+rn(c.sphere)+', {type: "Sphere"})')),s?u.signalRef(s):!!c),context:{$context:!0},groups:t.lookup(),parent:t.signals.parent?t.signalRef("parent"):null,index:t.markpath(),pulse:fe(i)})),s=fe(i),(i=t.add(Le(Kt(e.encode,e.type,v,e.style,t,{pulse:s})))).params.parent=t.encode(),e.transform&&e.transform.forEach(function(e){e=ln(e,t);(e.metadata.generates||e.metadata.changes)&&G.error("Mark transforms should not generate new data."),e.params.pulse=fe(i),t.add(i=e)}),e.sort&&(i=t.add(et({sort:t.compareRef(e.sort,!0),pulse:fe(i)}))),c=fe(i),(b||x)&&(p=fe(x=t.add(tt({layout:t.objectProperty(e.layout),legendMargin:t.config.legendMargin,mark:s,pulse:c})))),s=fe(v=t.add(Ve({mark:s,pulse:p||c}))),y&&(k&&((n=t.operators).pop(),x&&n.pop()),t.pushState(c,p||s,h),b?(c=t,p=d,h=(f=e).from.facet,b=h.name,m=fe(c.getData(h.data).output),h.name||G.error("Facet must have a name: "+G.stringValue(h)),h.data||G.error("Facet must reference a data set: "+G.stringValue(h)),h.field?g=c.add(He({field:c.fieldRef(h.field),pulse:m})):h.groupby?g=c.add(Ce({key:c.keyRef(h.groupby),group:fe(c.proxy(p.parent)),pulse:m})):G.error("Facet must specify groupby or field: "+G.stringValue(h)),h=(m=c.fork()).add(Fe()),c=m.add(Ze({pulse:fe(h)})),m.addData(b,new gn(m,h,h,c)),m.addSignal("parent",null),g.params.subflow={$subflow:Dn(f,m).toRuntime()}):k?(f=e,m=d,m=(d=t).add(He({pulse:m.pulse})),(d=d.fork()).add(Ze()),d.addSignal("parent",null),m.params.subflow={$subflow:Dn(f,d).toRuntime()}):Dn(e,t),t.popState(),k&&(x&&n.push(x),n.push(v))),S&&(i={method:!0===S.method?"parity":S.method,pulse:s},S.order&&(i.sort=t.compareRef({field:S.order})),S.bound&&(i.boundScale=t.scaleRef(S.bound.scale),i.boundOrient=S.bound.orient,i.boundTolerance=S.bound.tolerance),s=fe(t.add(Ie(i)))),S=t.add(Ke({pulse:s})),s=t.add(Ze({pulse:fe(S)},void 0,t.parent())),null!=e.name&&(a=e.name,t.addData(a,new gn(t,r,S,s)),e.on&&e.on.forEach(function(e){(e.insert||e.remove||e.toggle)&&G.error("Marks only support modify triggers."),yn(e,t,a)}))}function xn(e,t){var n,i,a,r,o,l,s,u,d,f,c,p,g,h,m,v,y=e.type||"symbol",b=t.config.legend,x=e.encode||{},k=x.legend||{},S=k.name||void 0,R=k.interactive,w=k.style,O=e.size||e.shape||e.fill||e.stroke||e.strokeDash||e.opacity;return O||G.error("Missing valid scale for legend."),p={orient:ke(e.orient,b.orient),title:null!=e.title},n=fe(t.add(Fe(null,[p]))),k=Jt({enter:Gt(c={},"fill",(d=b).fillColor)+Gt(c,"stroke",d.strokeColor)+Gt(c,"strokeWidth",d.strokeWidth)+Gt(c,"strokeDash",d.strokeDash)+Gt(c,"cornerRadius",d.cornerRadius)?c:void 0,update:{offset:Yt(ke(e.offset,b.offset)),padding:Yt(ke(e.padding,b.padding)),titlePadding:Yt(ke(e.titlePadding,b.titlePadding))}},k,Ot),i={update:{x:{field:{group:"padding"}},y:{field:{group:"padding"}},entryPadding:Yt(ke(e.entryPadding,b.entryPadding))}},"gradient"===y?(a=fe(t.add(Be({type:"gradient",scale:t.scaleRef(O),count:t.objectProperty(e.tickCount),values:t.objectProperty(e.values),formatSpecifier:t.property(e.format)}))),u=[(s=O,u=b,d=x.gradient,(c={}).enter=y={opacity:f={value:0},x:f,y:f},Gt(y,"width",u.gradientWidth),Gt(y,"height",u.gradientHeight),Gt(y,"stroke",u.gradientStrokeColor),Gt(y,"strokeWidth",u.gradientStrokeWidth),c.exit={opacity:f},c.update=s={x:f,y:f,fill:{gradient:s,start:[0,0],stop:[1,0]},opacity:{value:1}},Gt(s,"width",u.gradientWidth),Gt(s,"height",u.gradientHeight),Zt("rect","legend-gradient",null,void 0,void 0,c,d)),(y=b,f=x.labels,s=a,(u={}).enter=d={opacity:c={value:0}},Gt(d,"fill",y.labelColor),Gt(d,"font",y.labelFont),Gt(d,"fontSize",y.labelFontSize),Gt(d,"fontWeight",y.labelFontWeight),Gt(d,"baseline",y.gradientLabelBaseline),Gt(d,"limit",y.gradientLabelLimit),u.exit={opacity:c},u.update=c={opacity:{value:1},text:{field:bt}},d.x=c.x={field:xt,mult:y.gradientWidth},d.y=c.y={value:y.gradientHeight,offset:y.gradientLabelOffset},d.align=c.align={signal:'datum.perc<=0?"left":datum.perc>=1?"right":"center"'},Zt(an,It,St,xt,s,u,f))]):(a=fe(t.add(Be(m={scale:t.scaleRef(O),count:t.objectProperty(e.tickCount),values:t.objectProperty(e.values),formatSpecifier:t.property(e.format)}))),u=[(r=e,f=b,O=x.symbols,g=a,(v={}).enter=o={opacity:h={value:0}},Gt(o,"shape",f.symbolType),Gt(o,"size",f.symbolSize),Gt(o,"strokeWidth",f.symbolStrokeWidth),r.fill||(Gt(o,"fill",f.symbolFillColor),Gt(o,"stroke",f.symbolStrokeColor)),v.exit={opacity:h},v.update=l={opacity:{value:1}},o.x=l.x={field:"offset",mult:.5},o.y=l.y={field:"size",mult:.5,offset:{field:"total",offset:{field:{group:"entryPadding"},mult:{field:"index"}}}},wt.forEach(function(e){r[e]&&(l[e]=o[e]={scale:r[e],field:kt})}),Zt("symbol",Xt,null,kt,g,v,O)),(f=b,h=x.labels,g=a,(v={}).enter=a={opacity:O={value:0}},Gt(a,"align",f.labelAlign),Gt(a,"baseline",f.labelBaseline),Gt(a,"fill",f.labelColor),Gt(a,"font",f.labelFont),Gt(a,"fontSize",f.labelFontSize),Gt(a,"fontWeight",f.labelFontWeight),Gt(a,"limit",f.labelLimit),v.exit={opacity:O},v.update=O={opacity:{value:1},text:{field:bt}},a.x=O.x={field:"offset",offset:f.labelOffset},a.y=O.y={field:"size",mult:.5,offset:{field:"total",offset:{field:{group:"entryPadding"},mult:{field:"index"}}}},Zt(an,It,St,kt,g,v,h))],m.size=(g=e,v=t,m=Sn("fontSize",(h=u)[1].encode,v,St),m="max(ceil(sqrt("+(g.size?'scale("'+g.size+'",datum)':kn(Sn("size",h[0].encode,v)))+")),"+kn(m)+")",le(m,v))),u=[en(Tt,null,null,n,R,i,u)],p.title&&(g=b,h=x.title,m=n,v={value:0},b=(p=e).title,(x={}).enter=p={x:{field:{group:"padding"}},y:{field:{group:"padding"}},opacity:v},Gt(p,"align",g.titleAlign),Gt(p,"baseline",g.titleBaseline),Gt(p,"fill",g.titleColor),Gt(p,"font",g.titleFont),Gt(p,"fontSize",g.titleFontSize),Gt(p,"fontWeight",g.titleFontWeight),Gt(p,"limit",g.titleLimit),x.exit={opacity:v},x.update={opacity:{value:1},text:b&&b.signal?{signal:b.signal}:{value:b+""}},h=Zt(an,Ht,Rt,null,m,x,h),i.update.y.offset={field:{group:"titlePadding"},offset:Sn("fontSize",h.encode,t,Rt)},u.push(h)),u=en("legend",w,S,n,R,k,u),e.zindex&&(u.zindex=e.zindex),bn(u,t),0}function kn(e){return e&&e.signal||e}function Sn(e,t,n,i){t=t&&(t.update&&t.update[e]||t.enter&&t.enter[e]);return t&&t.signal?t:t?+t.value:(t=n.config.style[i])&&+t[e]}function Rn(e,t){e=G.isString(e)?{text:e}:e;var n=t.config.title,i=G.extend({},e.encode),a={orient:(null!=e.orient?e:n).orient},a=fe(t.add(Fe(null,[a])));return i.name=e.name,i.interactive=e.interactive,a=function(e,t,n,i){var a,r,o=e.text,l=e.orient||t.orient,s=e.anchor||t.anchor,u=l===vt||l===mt?-1:1,d=l===mt||l===yt,f={group:d?"width":"height"},c={};c.enter=a={opacity:{value:0}},Gt(a,"fill",t.color),Gt(a,"font",t.font),Gt(a,"fontSize",t.fontSize),Gt(a,"fontWeight",t.fontWeight),c.exit={opacity:{value:0}},c.update=a={opacity:{value:1},text:G.isObject(o)?o:{value:o+""},offset:Yt((null!=e.offset?e:t).offset||0)},o="start"===s?(r=0,"left"):"end"===s?(r=1,"right"):(r=.5,"center");s={field:f,mult:r},r=u<0?{value:0}:d?{field:{group:"height"}}:{field:{group:"width"}},d?(a.x=s,a.y=r,a.angle={value:0},a.baseline={value:l===mt?"bottom":"top"}):(a.x=r,a.y=s,a.angle={value:90*u},a.baseline={value:"bottom"});return a.align={value:o},a.limit={field:f},Gt(a,"angle",t.angle),Gt(a,"baseline",t.baseline),Gt(a,"limit",t.limit),Zt(an,"title",e.style||"group-title",null,i,c,n)}(e,n,i,a),e.zindex&&(a.zindex=e.zindex),bn(a,t),0}function wn(t,n){var i=[];t.transform&&t.transform.forEach(function(e){i.push(ln(e,n))}),t.on&&t.on.forEach(function(e){yn(e,n,t.name)}),n.addDataPipeline(t.name,function(e,t,n){var i,a,r,o,l,s=[],u=null,d=!1,f=!1;e.values?s.push(u=On({$ingest:e.values,$format:e.format})):e.url?s.push(u=On({$request:e.url,$format:e.format})):e.source&&(u=i=G.array(e.source).map(function(e){return fe(t.getData(e).output)}),s.push(null));for(a=0,r=n.length;a<r;++a)o=n[a],l=o.metadata,u||l.source||s.push(u=On()),s.push(o),l.generates&&(f=!0),l.modifies&&!f&&(d=!0),l.source?u=o:l.changes&&(u=null);i&&(r=i.length-1,s[0]=Je({derive:d,pulse:r?i:i[0]}),(d||r)&&s.splice(1,0,On()));u||s.push(On());return s.push(Ze({})),s}(t,n,i))}function On(e){e=Fe({},e);return e.metadata={source:!0},e}function zn(e,t){return{scale:e.scale,range:t}}function Pn(e,t,n,i,a){return{signal:'flush(range("'+e+'"), scale("'+e+'", datum.value), '+t+","+n+","+i+","+a+")"}}function jn(e,t){var n,i,a,r,o,l,s,u,d,f,c,p,g,h,m,v,y,b,x,k,S,R,w,O,z,P,j,D,$,E,_,V,F,A,W,L,C,M=(r=e,o=(f=t).config,p=r.orient,c=p===mt||p===yt?o.axisX:o.axisY,p=o["axis"+p[0].toUpperCase()+p.slice(1)],r="band"===f.scaleType(r.scale)&&o.axisBand,c||p||r?G.extend({},o.axis,c,p,r):o.axis),q=e.encode||{},B=(X=q.axis||{}).name||void 0,N=X.interactive,U=X.style,T={orient:e.orient,ticks:!!ke(e.ticks,M.ticks),labels:!!ke(e.labels,M.labels),grid:!!ke(e.grid,M.grid),domain:!!ke(e.domain,M.domain),title:!!ke(e.title,!1)},I=fe(t.add(Fe({},[T]))),X=Jt({update:{range:{signal:'abs(span(range("'+e.scale+'")))'},offset:Yt(ke(e.offset,0)),position:Yt(ke(e.position,0)),titlePadding:Yt(ke(e.titlePadding,M.titlePadding)),minExtent:Yt(ke(e.minExtent,M.minExtent)),maxExtent:Yt(ke(e.maxExtent,M.maxExtent))}},q.axis,Ot),H=fe(t.add(_e({scale:t.scaleRef(e.scale),extra:M.tickExtra,count:t.objectProperty(e.tickCount),values:t.objectProperty(e.values),formatSpecifier:t.property(e.format)}))),Y=[];return T.grid&&Y.push((i=M,h=q.grid,a=H,u=(n=e).orient,d=n.gridScale,c=(f=u===vt||u===mt?1:-1)*n.offset||0,(g={}).enter=r={opacity:p={value:0}},Gt(r,"stroke",i.gridColor),Gt(r,"strokeWidth",i.gridWidth),Gt(r,"strokeDash",i.gridDash),g.exit=o={opacity:p},g.update=p={},Gt(p,"opacity",i.gridOpacity),n={scale:n.scale,field:kt,band:i.bandPosition,round:i.tickRound,extra:i.tickExtra,offset:i.tickOffset},i=u===mt||u===yt?(l="x",s="y","height"):(l="y",s="x","width"),u=s+"2",p[l]=r[l]=o[l]=n,d?(r[s]={scale:d,range:0,mult:f,offset:c},p[u]=r[u]={scale:d,range:1,mult:f,offset:c}):(r[s]={value:c},p[u]=r[u]={signal:i,mult:f,offset:c}),Zt(nn,qt,null,kt,a,g,h))),T.ticks&&(y=ke(e.tickSize,M.tickSize),Y.push((O=M,P=q.ticks,z=H,k=y,b=(v=e).orient,m=b===vt||b===mt?-1:1,(j={}).enter=R={opacity:x={value:0}},Gt(R,"stroke",O.tickColor),Gt(R,"strokeWidth",O.tickWidth),j.exit=w={opacity:x},j.update=S={opacity:{value:1}},(k=Yt(k)).mult=m,O={scale:v.scale,field:kt,band:O.bandPosition,round:O.tickRound,extra:O.tickExtra,offset:O.tickOffset},b===mt||b===yt?(S.y=R.y=x,S.y2=R.y2=k,S.x=R.x=w.x=O):(S.x=R.x=x,S.x2=R.x2=k,S.y=R.y=w.y=O),Zt(nn,Nt,null,kt,z,j,P)))),T.labels&&(y=T.ticks?y:0,Y.push((g=M,h=q.labels,m=H,v=y,b=(E=e).orient,x=b===vt||b===mt?-1:1,k=E.scale,S=ke(E.labelPadding,g.labelPadding),D=ke(E.labelBound,g.labelBound),R=ke(E.labelFlush,g.labelFlush),w=null!=R&&!1!==R&&(R=+R)===R,O=+ke(E.labelFlushOffset,g.labelFlushOffset),z=ke(E.labelOverlap,g.labelOverlap),(j={}).enter=H={opacity:P={value:0}},Gt(H,"angle",g.labelAngle),Gt(H,"fill",g.labelColor),Gt(H,"font",g.labelFont),Gt(H,"fontSize",g.labelFontSize),Gt(H,"fontWeight",g.labelFontWeight),Gt(H,"limit",g.labelLimit),j.exit=y={opacity:P},j.update=P={opacity:{value:1},text:{field:bt}},(v=Yt(v)).mult=x,v.offset=Yt(S),v.offset.mult=x,g={scale:k,field:kt,band:.5,offset:g.tickOffset},b===mt||b===yt?(P.y=H.y=v,P.x=H.x=y.x=g,Gt(P,"align",w?Pn(k,R,'"left"','"right"','"center"'):"center"),w&&O&&Gt(P,"dx",Pn(k,R,-O,O,0)),Gt(P,"baseline",b===mt?"bottom":"top")):(P.x=H.x=v,P.y=H.y=y.y=g,Gt(P,"align","right"===b?"left":"right"),Gt(P,"baseline",w?Pn(k,R,'"bottom"','"top"','"middle"'):"middle"),w&&O&&Gt(P,"dy",Pn(k,R,O,-O,0))),E=Zt(an,Bt,St,kt,m,j,h),(z||D)&&(E.overlap={method:z,order:"datum.index",bound:D?{scale:k,orient:b,tolerance:+D}:null}),E))),T.domain&&Y.push((D=M,C=q.domain,W=I,A=(_=e).orient,(L={}).enter=F={opacity:E={value:0}},Gt(F,"stroke",D.domainColor),Gt(F,"strokeWidth",D.domainWidth),L.exit={opacity:E},L.update=V={opacity:{value:1}},D=A===mt||A===yt?($="x","y"):($="y","x"),A=$+"2",F[D]=E,V[$]=F[$]=zn(_,0),V[A]=F[A]=zn(_,1),Zt(nn,Mt,null,null,W,L,C))),T.title&&Y.push((V=M,F=q.title,A=I,W=(_=e).orient,L=_.title,C=W===vt||W===mt?-1:1,T=W===mt||W===yt,(M={}).enter=q={opacity:{value:0}},Gt(q,"align",V.titleAlign),Gt(q,"fill",V.titleColor),Gt(q,"font",V.titleFont),Gt(q,"fontSize",V.titleFontSize),Gt(q,"fontWeight",V.titleFontWeight),Gt(q,"limit",V.titleLimit),M.exit={opacity:{value:0}},M.update=L={opacity:{value:1},text:L&&L.signal?{signal:L.signal}:{value:L+""}},_={scale:_.scale,range:.5},T?(L.x=_,L.angle={value:0},L.baseline={value:W===mt?"bottom":"top"}):(L.y=_,L.angle={value:90*C},L.baseline={value:"bottom"}),Gt(L,"angle",V.titleAngle),Gt(L,"baseline",V.titleBaseline),Gt(L,"x",V.titleX)||!T||Qt("x",F)||(M.enter.auto={value:!0}),Gt(L,"y",V.titleY)||T||Qt("y",F)||(M.enter.auto={value:!0}),Zt(an,Ut,Rt,null,A,M,F))),Y=en("axis",U,B,I,N,X,Y),e.zindex&&(Y.zindex=e.zindex),bn(Y,t),0}var Dn=function(e,i,t){var n=G.array(e.signals),a=G.array(e.scales);return t||n.forEach(function(e){h(e,i)}),G.array(e.projections).forEach(function(e){gt(e,i)}),a.forEach(function(e){var t,n;n=i,e=(t=e).type||"linear",at.hasOwnProperty(e)||G.error("Unrecognized scale type: "+G.stringValue(e)),n.addScale(t.name,{type:e,domain:void 0})}),G.array(e.data).forEach(function(e){wn(e,i)}),a.forEach(function(e){st(e,i)}),n.forEach(function(e){je(e,i)}),G.array(e.axes).forEach(function(e){jn(e,i)}),G.array(e.marks).forEach(function(e){bn(e,i)}),G.array(e.legends).forEach(function(e){xn(e,i)}),e.title&&Rn(e.title,i),i.parseLambdas(),i},$n=G.toSet(["width","height","padding","autosize"]);function En(e,t){var n,i,a,r=t.config;return t.background=e.background||r.background,t.eventConfig=r.events,n=fe(t.root=t.add(de())),t.addSignal("width",e.width||0),t.addSignal("height",e.height||0),t.addSignal("padding",(a=e.padding,i=r,a=a||i.padding,G.isObject(a)?{top:s(a.top),bottom:s(a.bottom),left:s(a.left),right:s(a.right)}:{top:a=s(a),bottom:a,left:a,right:a})),t.addSignal("autosize",(i=e.autosize,a=r,i=i||a.autosize,G.isObject(i)?i:{type:i=i||"pad"})),G.array(e.signals).forEach(function(e){$n[e.name]||h(e,t)}),a=t.add(Fe()),i=Jt({enter:{x:{value:0},y:{value:0}},update:{width:{signal:"width"},height:{signal:"height"}}},e.encode),i=t.add(Le(Kt(i,tn,Lt,e.style,t,{pulse:fe(a)}))),r=t.add(tt({layout:t.objectProperty(e.layout),legendMargin:r.legendMargin,autosize:t.signalRef("autosize"),mark:n,pulse:fe(i)})),t.operators.pop(),t.pushState(fe(i),fe(r),null),Dn(e,t,!0),t.operators.push(r),r=t.add(Ve({mark:n,pulse:fe(r)})),r=t.add(Ke({pulse:fe(r)})),r=t.add(Ze({pulse:fe(r)})),t.addData("root",new gn(t,a,a,r)),t}function _n(e){this.config=e,this.bindings=[],this.field={},this.signals={},this.lambdas={},this.scales={},this.events={},this.data={},this.streams=[],this.updates=[],this.operators=[],this.background=null,this.eventConfig=null,this._id=0,this._subid=0,this._nextsub=[0],this._parent=[],this._encode=[],this._lookup=[],this._markpath=[]}function Vn(e){this.config=e.config,this.field=Object.create(e.field),this.signals=Object.create(e.signals),this.lambdas=Object.create(e.lambdas),this.scales=Object.create(e.scales),this.events=Object.create(e.events),this.data=Object.create(e.data),this.streams=[],this.updates=[],this.operators=[],this._id=0,this._subid=++e._nextsub[0],this._nextsub=e._nextsub,this._parent=e._parent.slice(),this._encode=e._encode.slice(),this._lookup=e._lookup.slice(),this._markpath=e._markpath}l=_n.prototype=Vn.prototype;function Fn(e){return(G.isArray(e)?function(e){for(var t,n="[",i=0,a=e.length;i<a;++i)t=e[i],n+=(0<i?",":"")+(G.isObject(t)?t.signal||Fn(t):G.stringValue(t));return n+"]"}:function(e){var t,n,i="{",a=0;for(t in e)n=e[t],i+=(1<++a?",":"")+G.stringValue(t)+":"+(G.isObject(n)?n.signal||Fn(n):G.stringValue(n));return i+"}"})(e)}l.fork=function(){return new Vn(this)},l.isSubscope=function(){return 0<this._subid},l.toRuntime=function(){return this.finish(),{background:this.background,operators:this.operators,streams:this.streams,updates:this.updates,bindings:this.bindings,eventConfig:this.eventConfig}},l.id=function(){return(this._subid?this._subid+":":0)+this._id++},l.add=function(t){return this.operators.push(t),t.id=this.id(),t.refs&&(t.refs.forEach(function(e){e.$ref=t.id}),t.refs=null),t},l.proxy=function(e){e=e instanceof se?fe(e):e;return this.add(Ge({value:e}))},l.addStream=function(e){return this.streams.push(e),e.id=this.id(),e},l.addUpdate=function(e){return this.updates.push(e),e},l.finish=function(){var e,t;for(e in this.root&&(this.root.root=!0),this.signals)this.signals[e].signal=e;for(e in this.scales)this.scales[e].scale=e;function n(e,t,n){e&&((e=e.data||(e.data={}))[t]||(e[t]=[])).push(n)}for(e in this.data)for(var i in n((t=this.data[e]).input,e,"input"),n(t.output,e,"output"),n(t.values,e,"values"),t.index)n(t.index[i],e,"index:"+i);return this},l.pushState=function(e,t,n){this._encode.push(fe(this.add(Ze({pulse:e})))),this._parent.push(t),this._lookup.push(n?fe(this.proxy(n)):null),this._markpath.push(-1)},l.popState=function(){this._encode.pop(),this._parent.pop(),this._lookup.pop(),this._markpath.pop()},l.parent=function(){return G.peek(this._parent)},l.encode=function(){return G.peek(this._encode)},l.lookup=function(){return G.peek(this._lookup)},l.markpath=function(){var e=this._markpath;return++e[e.length-1]},l.fieldRef=function(e,t){if(G.isString(e))return pe(e,t);e.signal||G.error("Unsupported field reference: "+G.stringValue(e));var n=e.signal,i=this.field[n];return i||(e={name:this.signalRef(n)},t&&(e.as=t),this.field[n]=i=fe(this.add(Me(e)))),i},l.compareRef=function(e,t){function n(e){return xe(e)?(a=!0,fe(i[e.signal])):e}var i=this.signals,a=!1,r=G.array(e.field).map(n),e=G.array(e.order).map(n);return t&&r.push(ce),a?fe(this.add(Ae({fields:r,orders:e}))):he(r,e)},l.keyRef=function(e,t){var n=this.signals,i=!1;return e=G.array(e).map(function(e){return xe(e)?(i=!0,fe(n[e.signal])):e}),i?fe(this.add(qe({fields:e,flat:t}))):(e={$key:e=e},t&&(e.$flat=!0),e)},l.sortRef=function(e){if(!e)return e;var t=[ve(e.op,e.field),ce],e=e.order||"ascending";return e.signal?fe(this.add(Ae({fields:t,orders:[e=this.signalRef(e.signal),e]}))):he(t,[e,e])},l.event=function(e,t){var n,i=e+":"+t;return this.events[i]||(n=this.id(),this.streams.push({id:n,source:e,type:t}),this.events[i]=n),this.events[i]},l.addSignal=function(e,t){this.signals.hasOwnProperty(e)&&G.error("Duplicate signal name: "+G.stringValue(e));t=t instanceof se?t:this.add(de(t));return this.signals[e]=t},l.getSignal=function(e){return this.signals[e]||G.error("Unrecognized signal name: "+G.stringValue(e)),this.signals[e]},l.signalRef=function(e){return this.signals[e]?fe(this.signals[e]):(this.lambdas.hasOwnProperty(e)||(this.lambdas[e]=this.add(de(null))),fe(this.lambdas[e]))},l.parseLambdas=function(){for(var e=Object.keys(this.lambdas),t=0,n=e.length;t<n;++t){var i=e[t],a=le(i,this),i=this.lambdas[i];i.params=a.$params,i.update=a.$expr}},l.property=function(e){return e&&e.signal?this.signalRef(e.signal):e},l.objectProperty=function(e){return e&&G.isObject(e)?this.signalRef(e.signal||Fn(e)):e},l.addBinding=function(e,t){this.bindings||G.error("Nested signals do not support binding: "+G.stringValue(e)),this.bindings.push(G.extend({signal:e},t))},l.addScaleProj=function(e,t){this.scales.hasOwnProperty(e)&&G.error("Duplicate scale or projection name: "+G.stringValue(e)),this.scales[e]=this.add(t)},l.addScale=function(e,t){this.addScaleProj(e,Qe(t))},l.addProjection=function(e,t){this.addScaleProj(e,Ye(t))},l.getScale=function(e){return this.scales[e]||G.error("Unrecognized scale name: "+G.stringValue(e)),this.scales[e]},l.projectionRef=l.scaleRef=function(e){return fe(this.getScale(e))},l.projectionType=l.scaleType=function(e){return this.getScale(e).params.type},l.addData=function(e,t){return this.data.hasOwnProperty(e)&&G.error("Duplicate data set name: "+G.stringValue(e)),this.data[e]=t},l.getData=function(e){return this.data[e]||G.error("Undefined data set name: "+G.stringValue(e)),this.data[e]},l.addDataPipeline=function(e,t){return this.data.hasOwnProperty(e)&&G.error("Duplicate data set name: "+G.stringValue(e)),this.addData(e,gn.fromEntries(this,t))};function An(e){var a={padding:0,autosize:"pad",background:null,events:{defaults:{allow:["wheel"]}},group:null,mark:null,arc:{fill:Mn},area:{fill:Mn},image:null,line:{stroke:Mn,strokeWidth:Cn},path:{stroke:Mn},rect:{fill:Mn},rule:{stroke:qn},shape:{stroke:Mn},symbol:{fill:Mn,size:64},text:{fill:qn,font:Wn,fontSize:11},style:{"guide-label":{fill:qn,font:Wn,fontSize:10},"guide-title":{fill:qn,font:Wn,fontSize:11,fontWeight:"bold"},"group-title":{fill:qn,font:Wn,fontSize:13,fontWeight:"bold"},point:{size:Ln,strokeWidth:Cn,shape:"circle"},circle:{size:Ln,strokeWidth:Cn},square:{size:Ln,strokeWidth:Cn,shape:"square"},cell:{fill:"transparent",stroke:Nn}},axis:{minExtent:0,maxExtent:200,bandPosition:.5,domain:!0,domainWidth:1,domainColor:Bn,grid:!1,gridWidth:1,gridColor:Nn,gridOpacity:1,labels:!0,labelAngle:0,labelLimit:180,labelPadding:2,ticks:!0,tickColor:Bn,tickOffset:0,tickRound:!0,tickSize:5,tickWidth:1,titleAlign:"center",titlePadding:4},axisBand:{tickOffset:-1},legend:{orient:"right",offset:18,padding:0,entryPadding:5,titlePadding:5,gradientWidth:100,gradientHeight:20,gradientStrokeColor:Nn,gradientStrokeWidth:0,gradientLabelBaseline:"top",gradientLabelOffset:2,labelAlign:"left",labelBaseline:"middle",labelOffset:8,labelLimit:160,symbolType:"circle",symbolSize:100,symbolFillColor:"transparent",symbolStrokeColor:Bn,symbolStrokeWidth:1.5,titleAlign:"left",titleBaseline:"top",titleLimit:180},title:{orient:"top",anchor:"middle",offset:4},range:{category:{scheme:"tableau10"},ordinal:{scheme:"blues",extent:[.2,1]},heatmap:{scheme:"viridis"},ramp:{scheme:"blues",extent:[.2,1]},diverging:{scheme:"blueorange"},symbol:["circle","square","triangle-up","cross","diamond","triangle-right","triangle-down","triangle-left"]}};return(e||[]).forEach(function(e){var t,n,i;if(e)for(t in e)if("style"===t)for(t in i=a.style||(a.style={}),e.style)i[t]=G.extend(i[t]||{},e.style[t]);else n=e[t],a[t]=G.isObject(n)&&!G.isArray(n)?G.extend(G.isObject(a[t])?a[t]:{},n):n}),a}var Wn="sans-serif",Ln=30,Cn=2,Mn="#4c78a8",qn="#000",Bn="#888",Nn="#ddd";e.parse=function(e,t){return G.isObject(e)||G.error("Input Vega specification must be an object."),En(e,new _n(An([t,e.config]))).toRuntime()},e.config=An,e.signal=h,e.signalUpdates=je,e.stream=Se,e.codeGenerator=oe,e.functionContext=te,e.expressionFunction=ae,e.MarkRole=Wt,e.FrameRole=Lt,e.ScopeRole=Ct,e.AxisRole="axis",e.AxisDomainRole=Mt,e.AxisGridRole=qt,e.AxisLabelRole=Bt,e.AxisTickRole=Nt,e.AxisTitleRole=Ut,e.LegendRole="legend",e.LegendEntryRole=Tt,e.LegendLabelRole=It,e.LegendSymbolRole=Xt,e.LegendTitleRole=Ht,e.Scope=_n,e.DataScope=gn,e.formatLocale=a.formatDefaultLocale,e.timeFormatLocale=r.timeFormatDefaultLocale,Object.defineProperty(e,"__esModule",{value:!0})});