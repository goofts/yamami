!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports,require("vega-util"),require("vega-dataflow"),require("vega-scenegraph"),require("d3-array"),require("vega-parser"),require("vega-runtime")):"function"==typeof define&&define.amd?define(["exports","vega-util","vega-dataflow","vega-scenegraph","d3-array","vega-parser","vega-runtime"],n):n(e.vega=e.vega||{},e.vega,e.vega,e.vega,e.d3,e.vega,e.vega)}(this,function(e,c,l,h,f,o,u){"use strict";function d(e){var i=e._signals.cursor;i||(e._signals.cursor=i=e.add({user:a,item:null})),e.on(e.events("view","mousemove"),i,function(e,n){var t=i.value,r=t?c.isString(t)?t:t.user:a,n=n.item&&n.item.cursor||null;return t&&r===t.user&&n==t.item?t:{user:r,item:n}}),e.add(null,function(e){var n=e.cursor,e=this.value;return c.isString(n)||(e=n.item,n=n.user),n=(!n||n===a)&&e||n,"undefined"!=typeof document&&document.body&&(document.body.style.cursor=n),e},{cursor:i})}var a="default";function t(e,n){e=e._runtime.data;return e.hasOwnProperty(n)||c.error("Unrecognized data set: "+n),e[n]}function r(e,n){l.isChangeSet(n)||c.error("Second argument to changes must be a changeset.");e=t(this,e);return e.modified=!0,this.pulse(e.input,n)}function s(e){var n=e.padding();return Math.max(0,e._viewWidth+n.left+n.right)}function g(e){var n=e.padding();return Math.max(0,e._viewHeight+n.top+n.bottom)}function p(e){var n=e.padding(),e=e._origin;return[n.left+e[0],n.top+e[1]]}function v(e,n,t){var r,i,a,s,o,u=e._renderer.scene();function d(e){var n,t=o;if(e)for(n=a;n;n=n.mark.group)if(n.mark.name===e){t=n;break}return t&&t.mark&&t.mark.interactive?t:{}}function l(e){if(!e)return s;c.isString(e)&&(e=d(e));for(var n=s.slice();e;)n[0]-=e.x||0,n[1]-=e.y||0,e=e.mark&&e.mark.group;return n}return u&&(i=p(e),r=n.changedTouches?n.changedTouches[0]:n,(r=h.point(r,u))[0]-=i[0],r[1]-=i[1]),n.dataflow=e,n.vega=(e=e,s=r,o=(a=t)?"group"===a.mark.marktype?a:a.mark.group:null,{view:c.constant(e),item:c.constant(a||{}),group:d,xy:l,x:function(e){return l(e)[0]},y:function(e){return l(e)[1]}}),n.item=t,n}var _="view";function i(e){return e.item}function m(e){e=e.item.mark.source;return e.source||e}function y(t){return function(e,n){return n.vega.view().changeset().encode(n.item,t)}}function w(n,e,t){if(e){var r=t.param,i=t.state;return i||(i=t.state={elements:null,active:!1,set:null,update:function(e){i.source=!0,n.signal(r.signal,e).run()}},r.debounce&&(i.update=c.debounce(r.debounce,i.update))),function(e,n,t,r){var i=z("div",{class:"vega-bind"});i.appendChild(z("span",{class:"vega-bind-name"},t.name||t.signal)),n.appendChild(i);var a=k;switch(t.input){case"checkbox":a=L;break;case"select":a=x;break;case"radio":a=C;break;case"range":a=S}a(e,i,t,r)}(i,e,r,n.signal(r.signal)),i.active||(n.on(n._signals[r.signal],null,function(){i.source?i.source=!1:i.set(n.signal(r.signal))}),i.active=!0),i}}var z=function(e,n,t){var r,i=document.createElement(e);for(r in n)i.setAttribute(r,n[r]);return null!=t&&(i.textContent=t),i},n="vega-bind-radio",b="vega-option-";function k(e,n,t,r){var i,a=z("input");for(i in t)"signal"!==i&&"element"!==i&&a.setAttribute("input"===i?"type":i,t[i]);a.setAttribute("name",t.signal),a.value=r,n.appendChild(a),a.addEventListener("input",function(){e.update(a.value)}),e.elements=[a],e.set=function(e){a.value=e}}function L(e,n,t,r){t={type:"checkbox",name:t.signal};r&&(t.checked=!0);var i=z("input",t);n.appendChild(i),i.addEventListener("change",function(){e.update(i.checked)}),e.elements=[i],e.set=function(e){i.checked=!!e||null}}function x(e,n,r,t){var i=z("select",{name:r.signal});r.options.forEach(function(e){var n={value:e};E(e,t)&&(n.selected=!0),i.appendChild(z("option",n,e+""))}),n.appendChild(i),i.addEventListener("change",function(){e.update(r.options[i.selectedIndex])}),e.elements=[i],e.set=function(e){for(var n=0,t=r.options.length;n<t;++n)if(E(r.options[n],e))return void(i.selectedIndex=n)}}function C(i,e,r,a){var s=z("span",{class:n});e.appendChild(s),i.elements=r.options.map(function(e){var n=b+r.signal+"-"+e,t={id:n,type:"radio",name:r.signal,value:e};E(e,a)&&(t.checked=!0);t=z("input",t);return t.addEventListener("change",function(){i.update(e)}),s.appendChild(t),s.appendChild(z("label",{for:n},e+"")),t}),i.set=function(e){for(var n=i.elements,t=0,r=n.length;t<r;++t)E(n[t].value,e)&&(n[t].checked=!0)}}function S(e,n,t,r){r=void 0!==r?r:(+t.max+ +t.min)/2;var i=t.min||Math.min(0,+r)||0,a=t.max||Math.max(100,+r)||100,s=t.step||f.tickStep(i,a,100),o=z("input",{type:"range",name:t.signal,min:i,max:a,step:s});o.value=r;var u=z("label",{},+r);function d(){u.textContent=o.value,e.update(+o.value)}n.appendChild(o),n.appendChild(u),o.addEventListener("input",d),o.addEventListener("change",d),e.elements=[o],e.set=function(e){o.value=e,u.textContent=e}}function E(e,n){return e===n||e+""==n+""}function T(e,n,t,r,i){return(n=n||new r(e.loader())).initialize(t,s(e),g(e),p(e),i).background(e._background)}function A(e,n,t,r){var i=new r(e.loader(),function(n){var e=n.tooltip(),t=null;e&&(t=function(){try{e.apply(this,arguments)}catch(e){n.error(e)}});return t}(e)).scene(e.scenegraph().root).initialize(t,p(e),e);return n&&n.handlers().forEach(function(e){i.on(e.type,e.handler)}),i}function R(n,t){if("string"==typeof t){if("undefined"==typeof document)return n.error("DOM document instance not found."),null;if(!(t=document.querySelector(t)))return n.error("Signal bind element not found: "+t),null}if(t)try{t.innerHTML=""}catch(e){t=null,n.error(e)}return t}function D(e,n,t){var r=h.renderModule(n),i=r&&r.headless;return i?e.runAsync().then(function(){return T(e,null,null,i,t).renderAsync(e._scenegraph.root)}):Promise.reject("Unrecognized renderer type: "+n)}var H="width",O="height",j="padding",M={skip:!0};function U(e,n){var t=e.autosize(),e=e.padding();return n-(t&&t.contains===j?e.left+e.right:0)}function q(e,n){var t=e.autosize(),e=e.padding();return n-(t&&t.contains===j?e.top+e.bottom:0)}function W(e,n){return n.modified&&c.isArray(n.input.value)&&e.indexOf("_:vega:_")}function V(e,n){return!("parent"===e||n instanceof l.transforms.proxy)}function P(e,n,t,r){e.element().setAttribute("title",null==(r=r)?"":c.isArray(r)?G(r):c.isObject(r)&&!c.isDate(r)?function(t){return Object.keys(t).map(function(e){var n=t[e];return e+": "+(c.isArray(n)?G:I)(n)}).join("\n")}(r):r+"")}function G(e){return"["+e.map(I).join(", ")+"]"}function I(e){return c.isArray(e)?"[…]":c.isObject(e)&&!c.isDate(e)?"{…}":e}function B(e,n){var t=this;n=n||{},l.Dataflow.call(t),t.loader(n.loader||t._loader),t.logLevel(n.logLevel||0),t._el=null,t._renderType=n.renderer||h.RenderType.Canvas,t._scenegraph=new h.Scenegraph;var r=t._scenegraph.root;t._renderer=null,t._tooltip=n.tooltip||P,t._redraw=!0,t._handler=(new h.CanvasHandler).scene(r),t._preventDefault=!1,t._eventListeners=[],t._resizeListeners=[];var i,a=function(e,n,t){t=t||o.functionContext;return u.parse(n,u.context(e,l.transforms,t))}(t,e,n.functions);function s(){i._autosize=i._resize=1}t._runtime=a,t._signals=a.signals,t._bind=(e.bindings||[]).map(function(e){return{state:null,param:c.extend({},e)}}),a.root&&a.root.set(r),r.source=a.data.root.input,t.pulse(a.data.root.input,t.changeset().insert(r.items)),t._background=a.background||null,t._eventConfig=(n=a.eventConfig,(e=(n=c.extend({},n)).defaults)&&(c.isArray(e.prevent)&&(e.prevent=c.toSet(e.prevent)),c.isArray(e.allow)&&(e.allow=c.toSet(e.allow))),n),t._width=t.width(),t._height=t.height(),t._viewWidth=U(t,t._width),t._viewHeight=q(t,t._height),t._origin=[0,0],t._resize=0,t._autosize=1,r=(i=t)._signals,a=r[H],e=r[O],n=r[j],i._resizeWidth=i.add(null,function(e){i._width=e.size,i._viewWidth=U(i,e.size),s()},{size:a}),i._resizeHeight=i.add(null,function(e){i._height=e.size,i._viewHeight=q(i,e.size),s()},{size:e}),r=i.add(null,s,{pad:n}),i._resizeWidth.rank=a.rank+1,i._resizeHeight.rank=e.rank+1,r.rank=n.rank+1,d(t)}var N=c.inherits(B,l.Dataflow);function F(e,n){return e._signals.hasOwnProperty(n)?e._signals[n]:c.error("Unrecognized signal name: "+c.stringValue(n))}function J(e,n){e=(e._targets||[]).filter(function(e){e=e._update;return e&&e.handler===n});return e.length?e[0]:null}N.run=function(e){if(l.Dataflow.prototype.run.call(this,e),this._redraw||this._resize)try{this.render()}catch(e){this.error(e)}return this},N.render=function(){var e,n,t,r;return this._renderer&&(this._resize&&(this._resize=0,n=p(e=this),t=s(e),r=g(e),e._renderer.background(e._background),e._renderer.resize(t,r,n),e._handler.origin(n),e._resizeListeners.forEach(function(e){e(t,r)})),this._renderer.render(this._scenegraph.root)),this._redraw=!1,this},N.dirty=function(e){this._redraw=!0,this._renderer&&this._renderer.dirty(e)},N.container=function(){return this._el},N.scenegraph=function(){return this._scenegraph},N.origin=function(){return this._origin.slice()},N.signal=function(e,n,t){e=F(this,e);return 1===arguments.length?e.value:this.update(e,n,t)},N.background=function(e){return arguments.length?(this._background=e,this._resize=1,this):this._background},N.width=function(e){return arguments.length?this.signal("width",e):this.signal("width")},N.height=function(e){return arguments.length?this.signal("height",e):this.signal("height")},N.padding=function(e){return arguments.length?this.signal("padding",e):this.signal("padding")},N.autosize=function(e){return arguments.length?this.signal("autosize",e):this.signal("autosize")},N.renderer=function(e){return arguments.length?(h.renderModule(e)||c.error("Unrecognized renderer type: "+e),e!==this._renderType&&(this._renderType=e,this._resetRenderer()),this):this._renderType},N.tooltip=function(e){return arguments.length?(e!==this._tooltip&&(this._tooltip=e,this._resetRenderer()),this):this._tooltip},N.loader=function(e){return arguments.length?(e!==this._loader&&(l.Dataflow.prototype.loader.call(this,e),this._resetRenderer()),this):this._loader},N.resize=function(){return this._autosize=1,this},N._resetRenderer=function(){this._renderer&&(this._renderer=null,this.initialize(this._el))},N._resizeView=function(t,r,i,a,s,o){this.runAfter(function(e){var n=0;e._autosize=0,e.width()!==i&&(n=1,e.signal(H,i,M),e._resizeWidth.skip(!0)),e.height()!==a&&(n=1,e.signal(O,a,M),e._resizeHeight.skip(!0)),e._viewWidth!==t&&(e._resize=1,e._viewWidth=t),e._viewHeight!==r&&(e._resize=1,e._viewHeight=r),e._origin[0]===s[0]&&e._origin[1]===s[1]||(e._resize=1,e._origin=s),n&&e.run("enter"),o&&e.runAfter(function(){e.resize()})},!1,1)},N.addEventListener=function(e,n){return this._handler.on(e,n),this},N.removeEventListener=function(e,n){return this._handler.off(e,n),this},N.addResizeListener=function(e){var n=this._resizeListeners;return n.indexOf(e)<0&&n.push(e),this},N.removeResizeListener=function(e){var n=this._resizeListeners,e=n.indexOf(e);return 0<=e&&n.splice(e,1),this},N.addSignalListener=function(e,n){var t=F(this,e),r=J(t,n);return r||((r=function(){n(e,t.value)}).handler=n,this.on(t,null,r)),this},N.removeSignalListener=function(e,n){e=F(this,e),n=J(e,n);return n&&e._targets.remove(n),this},N.preventDefault=function(e){return arguments.length?(this._preventDefault=e,this):this._preventDefault},N.tooltipHandler=function(e){var n=this._handler;return arguments.length?(n.handleTooltip=e||h.Handler.prototype.handleTooltip,this):n.handleTooltip},N.events=function(s,o,e){function n(e,n){var t,r,i,a;s!==_||(r=o,i=(a=(t=u)._eventConfig.defaults)&&a.prevent,a=a&&a.allow,!1===i||!0===a||!0!==i&&!1!==a&&(i?!i[r]:a?a[r]:!t.preventDefault()))||e.preventDefault();try{d.receive(v(u,e,n))}catch(e){u.error(e)}finally{u.run()}}var t,u=this,d=new l.EventStream(e);if(s===_)return u.addEventListener(o,n),d;if("window"===s?"undefined"!=typeof window&&(t=[window]):"undefined"!=typeof document&&(t=document.querySelectorAll(s)),!t)return u.warn("Can not resolve event source: "+s),d;for(var r=0,i=t.length;r<i;++r)t[r].addEventListener(o,n);return u._eventListeners.push({type:o,sources:t,handler:n}),d},N.finalize=function(){for(var e,n,t=this._eventListeners,r=t.length;0<=--r;)for(e=(n=t[r]).sources.length;0<=--e;)n.sources[e].removeEventListener(n.type,n.handler)},N.hover=function(e,n){return n=[n||"update",(e=[e||"hover"])[0]],this.on(this.events("view","mouseover",i),m,y(e)),this.on(this.events("view","mouseout",i),m,y(n)),this},N.data=function(e){return t(this,e).values.value},N.change=r,N.insert=function(e,n){return r.call(this,e,l.changeset().insert(n))},N.remove=function(e,n){return r.call(this,e,l.changeset().remove(n))},N.initialize=function(e,n){var t=this,r=t._renderType,i=h.renderModule(r);return e=t._el=e?R(t,e):null,i||t.error("Unrecognized renderer type: "+r),r=i.handler||h.CanvasHandler,i=e?i.renderer:i.headless,t._renderer=i?T(t,t._renderer,e,i):null,t._handler=A(t,t._handler,e,r),t._redraw=!0,e&&(n=n?R(t,n):e.appendChild(z("div",{class:"vega-bindings"})),t._bind.forEach(function(e){e.param.element&&(e.element=R(t,e.param.element))}),t._bind.forEach(function(e){w(t,e.element||n,e)})),t},N.toImageURL=function(n,e){return n!==h.RenderType.Canvas&&n!==h.RenderType.SVG&&n!==h.RenderType.PNG?Promise.reject("Unrecognized image type: "+n):D(this,n,e).then(function(e){return n===h.RenderType.SVG?function(e,n){n=new Blob([e],{type:n});return window.URL.createObjectURL(n)}(e.svg(),"image/svg+xml"):e.canvas().toDataURL("image/png")})},N.toCanvas=function(e){return D(this,h.RenderType.Canvas,e).then(function(e){return e.canvas()})},N.toSVG=function(e){return D(this,h.RenderType.SVG,e).then(function(e){return e.svg()})},N.getState=function(e){return this._runtime.getState(e||{data:W,signals:V,recurse:!0})},N.setState=function(e){var n=this;return n.runAfter(function(){n._trigger=!1,n._runtime.setState(e),n.run().runAfter(function(){n._trigger=!0})}),this},e.View=B,Object.defineProperty(e,"__esModule",{value:!0})});